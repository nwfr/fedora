# Fedora Server Kickstart for Dual NVMe Btrfs RAID1
# Refined by AI Review
lang en_US.UTF-8
keyboard us
timezone UTC --utc

# Network
network --bootproto=dhcp --device=link --activate --hostname=home-srv

# Security
firewall --enabled --service=ssh,mdns,cockpit
selinux --enforcing

# Root setup
rootpw --lock

# 4a. Primary admin user
user --name=n00r --groups=wheel,libvirt,podman,video,render --shell=/bin/bash --iscrypted --password=$6$KXlajFarJ6L9Upy8$WZvwqqLDEXx/sXYDcks0MAuhN3SX8X7m3SQayzmX1hbqUSATxcx03SO6t7RCgtVXkpMxqjnubHWuEXElGxzHR/ 
# this is a temporary password of user n00r
#  Once you have verified SSH works, you can lock the password manually later by running `passwd -l n00r` on the server.


# Services
services --enabled=sshd,chronyd,podman,fstrim.timer 
# libvirtd

# Reboot
reboot

# ==============================================================================
# STORAGE CONFIGURATION (Resiliency Fixes)
# ==============================================================================
ignoredisk --only-use=nvme0n1,nvme1n1
clearpart --all --initlabel --drives=nvme0n1,nvme1n1

# A. EFI Partitions (CRITICAL FIX)
# We put the main EFI on disk 1.
part /boot/efi --fstype="efi" --size=600 --ondisk=nvme0n1
# We create a backup EFI partition on disk 2, mounted elsewhere for now.
# This ensures the partition structure exists on disk 2. 
# You can clone the data to it in %post or manually later.
part /boot/efi2 --fstype="efi" --size=600 --ondisk=nvme1n1

# B. Boot Partition (RAID1 ext4)
part raid.01 --size=1024 --ondisk=nvme0n1
part raid.02 --size=1024 --ondisk=nvme1n1
raid /boot --level=1 --device=md0 --fstype="ext4" raid.01 raid.02

# C. Btrfs RAID1 Volume
part btrfs.01 --size=1 --grow --ondisk=nvme0n1
part btrfs.02 --size=1 --grow --ondisk=nvme1n1

btrfs none --label=fedora --data=raid1 --metadata=raid1 btrfs.01 btrfs.02

# D. Subvolumes
btrfs /                    --subvol --name=@           LABEL=fedora
btrfs /home                --subvol --name=@home       LABEL=fedora
btrfs /var/lib/containers  --subvol --name=@containers LABEL=fedora
btrfs /srv/ai              --subvol --name=@ai         LABEL=fedora
btrfs /srv/backups         --subvol --name=@backups    LABEL=fedora
btrfs /var/lib/libvirt/images --subvol --name=@images  LABEL=fedora

# ==============================================================================
# PACKAGE SELECTION
# ==============================================================================
%packages
@server-product-environment
@headless-management
@virtualization
btrfs-progs
podman
libvirt
qemu-kvm
virt-install
cockpit-system
cockpit-machines
cockpit-podman
git
htop
neofetch
%end

# ==============================================================================
# POST-INSTALLATION SCRIPT
# ==============================================================================
%post --log=/root/ks-post.log

# 1. EFI Redundancy Sync
# Copy contents of main EFI to the backup EFI partition
# This ensures that if drive 1 dies, drive 2 has a valid EFI folder structure
cp -r /boot/efi/EFI /boot/efi2/

# 2. Fstab Optimization (Compression & SSD Tweaks)
# Safer sed command to locate the btrfs mounts
sed -i 's|defaults,subvol=|defaults,compress=zstd:1,noatime,discard=async,space_cache=v2,subvol=|g' /etc/fstab

# 3. VM Image Optimization (NoCoW & NoCompression)
# First, remove compression flag from the images subvolume in fstab
sed -i '/@images/s/compress=zstd:1,//' /etc/fstab

# CRITICAL: Ensure directory is empty and set NoCoW
# libvirt might have created files during package install. 
# We stop the service to release locks, clean it, attribute it, and restart.
systemctl stop libvirtd
mkdir -p /var/lib/libvirt/images
# The +C attribute ONLY works on empty files/dirs.
chattr +C /var/lib/libvirt/images
systemctl start libvirtd

# 4. SSH Hardening & Setup
USER=n00r
HOME_DIR=/home/$USER
SSH_DIR=$HOME_DIR/.ssh

mkdir -p $SSH_DIR
chmod 700 $SSH_DIR

cat > $SSH_DIR/authorized_keys <<'EOF'
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDCIYJ/QsNTku96RXobj7FMobouMeIDCufVlabHTiYMo n00r@n00r-laptop
EOF

chmod 600 $SSH_DIR/authorized_keys
chown -R $USER:$USER $HOME_DIR

# 5. SSH Configuration
sed -i -e 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sed -i -e 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config

# 6. System Tuning
# Enable timers
systemctl enable btrfs-scrub.timer
# fstrim is technically redundant with discard=async but good as a fallback
systemctl enable fstrim.timer 
systemctl enable cockpit.socket

%end
